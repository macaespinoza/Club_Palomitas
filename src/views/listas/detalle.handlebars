<div class="container py-4">
    <div class="row align-items-center mb-4">
        <div class="col-md-2 d-none d-md-block"></div>
        <div class="col-12 col-md-8 text-center">
            <h1 class="display-5 fw-bold">{{lista.nombre}}</h1>
            {{#if lista.descripcion}}
            <p class="text-muted lead fw-bold">{{lista.descripcion}}</p>
            {{/if}}
            <span class="badge {{#if lista.es_publica}}bg-success{{else}}bg-secondary{{/if}}">
                {{#if lista.es_publica}}Pública{{else}}Privada{{/if}}
            </span>
        </div>
        <div class="col-12 col-md-2 text-center text-md-end mt-3 mt-md-0">
            <a href="/listas" class="btn btn-secondary w-100 w-md-auto mb-2">
                <i class="bi bi-list-ul me-1"></i>Mis listas
            </a>
            {{#if esPropietario}}
            <button class="btn btn-danger w-100 w-md-auto" onclick="eliminarLista({{lista.id}})">
                <i class="bi bi-trash me-1"></i>Eliminar Lista
            </button>
            {{/if}}
        </div>
    </div>

    {{#if esPropietario}}
    <div class="card search-card mb-4">
        <div class="card-body">
            <h5 class="card-title">
                <i class="bi bi-search me-2"></i>Buscar y Agregar Películas
            </h5>
            <form id="buscarForm" class="row g-3">
                <div class="col-md-9">
                    <input type="text" id="buscarInput" class="form-control" placeholder="Buscar películas en OMDb..."
                        required>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-info w-100 h-100">
                        <i class="bi bi-search me-1"></i>Buscar
                    </button>
                </div>
            </form>
            <div id="resultadosBusqueda" class="row row-cols-2 row-cols-md-2 row-cols-lg-4 g-3 mt-2"></div>
        </div>
    </div>
    {{/if}}

    <h3 class="mb-3">Películas en esta lista</h3>
    {{#if lista.peliculas.length}}
    <div class="row row-cols-2 row-cols-md-2 row-cols-lg-4 g-3">
        {{#each lista.peliculas}}
        <div class="col">
            <div class="card movie-card h-100 d-flex flex-column">
                <img src="{{this.poster}}" class="card-img-top" alt="{{this.titulo}}"
                    onerror="this.src='https://via.placeholder.com/200x300?text=No+Image'">
                <div class="card-body d-flex flex-column">
                    <div class="card-content-top">
                        <h6 class="card-title-container mb-1">
                            <span class="card-title-text" tabindex="0" data-bs-toggle="popover"
                                data-bs-trigger="hover focus" data-bs-placement="top"
                                data-bs-content="{{this.titulo}}">{{this.titulo}}</span>
                        </h6>
                        <span class="badge badge-tipo mb-1">{{this.tipo}}</span>
                        <p class="card-text small mb-0">{{this.anio}}</p>
                    </div>

                    <div class="card-separator my-2"></div>

                    <div class="mt-auto card-content-bottom">
                        {{#if this.mi_calificacion}}
                        <div class="stars-display mb-2">
                            {{#each (range 1 6)}}
                            <i
                                class="bi bi-star{{#if (lte this ../this.mi_calificacion)}}-fill text-warning{{/if}}"></i>
                            {{/each}}
                        </div>
                        {{else}}
                        <div class="mb-2">
                            <span class="badge badge-sin-calificar">
                                <i class="bi bi-star me-1"></i>Sin calificar aún
                            </span>
                        </div>
                        {{/if}}

                        {{#if this.mi_comentario}}
                        <div class="review-preview-container mb-2">
                            <span class="comment-preview-text" tabindex="0" data-bs-toggle="popover"
                                data-bs-trigger="hover focus" data-bs-placement="top"
                                data-bs-content="{{this.mi_comentario}}">
                                <i class="bi bi-chat-quote me-1"></i>"{{this.mi_comentario}}"
                            </span>
                        </div>
                        {{/if}}

                        {{#if ../esPropietario}}
                        <div class="d-flex justify-content-center gap-2 card-actions-buttons pt-2">
                            <button class="btn btn-sm btn-card-action btn-icon-only btn-comment-action"
                                data-id="{{this.id}}" data-titulo="{{this.titulo}}"
                                data-calificacion="{{this.mi_calificacion}}" data-comentario="{{this.mi_comentario}}"
                                title="Comentario">
                                <i class="bi bi-chat-left-text-fill"></i>
                            </button>
                            <button class="btn btn-sm btn-card-action btn-icon-only btn-review" data-id="{{this.id}}"
                                data-titulo="{{this.titulo}}" data-calificacion="{{this.mi_calificacion}}"
                                data-comentario="{{this.mi_comentario}}" title="Calificación">
                                <i class="bi bi-star-fill"></i>
                            </button>
                            {{#if this.mi_calificacion}}
                            <a href="/resena/{{this.id}}?lista={{../lista.id}}"
                                class="btn btn-sm btn-card-action btn-icon-only btn-share-action"
                                title="Compartir reseña">
                                <i class="bi bi-share-fill"></i>
                            </a>
                            {{/if}}
                            <button class="btn btn-sm btn-card-action btn-icon-only btn-delete-action"
                                onclick="removerPelicula({{../lista.id}}, {{this.id}})" title="Eliminar">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                        {{/if}}
                    </div>
                </div>
            </div>
        </div>
        {{/each}}
    </div>
    {{else}}
    <div class="text-center py-5">
        <i class="bi bi-film display-1 text-muted mb-3"></i>
        <p class="lead text-muted">Esta lista está vacía. Usa el buscador arriba para agregar películas.</p>
    </div>
    {{/if}}
</div>

<div class="modal fade" id="modalReview" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="modalReviewTitle">Agregar Review</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formReview">
                    <input type="hidden" id="reviewPeliculaId">
                    <div class="mb-3">
                        <label class="form-label">Calificación</label>
                        <div class="stars-rating" id="starsRating">
                            <i class="bi bi-star" data-rating="1"></i>
                            <i class="bi bi-star" data-rating="2"></i>
                            <i class="bi bi-star" data-rating="3"></i>
                            <i class="bi bi-star" data-rating="4"></i>
                            <i class="bi bi-star" data-rating="5"></i>
                        </div>
                        <input type="hidden" id="calificacion" name="calificacion">
                    </div>
                    <div class="mb-3">
                        <label for="comentario" class="form-label">Comentario</label>
                        <textarea class="form-control bg-secondary text-light border-dark" id="comentario"
                            name="comentario" rows="3" placeholder="¿Por qué te gusta esta película?"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarReview()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
    const listaId = {{ lista.id }};

    // INICIALIZAR POPOVERS
    document.addEventListener('DOMContentLoaded', function () {
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl);
        });
    });

    // BOTON COMENTARIO
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('.btn-comment-action');
        if (btn) {
            const id = btn.dataset.id;
            const titulo = btn.dataset.titulo;
            const calificacion = btn.dataset.calificacion;
            const comentario = btn.dataset.comentario;
            mostrarModalReview(id, titulo, calificacion, comentario);
        }
    });

    // BUSCAR PELICULAS
    document.getElementById('buscarForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = document.getElementById('buscarInput').value;
        const resultados = document.getElementById('resultadosBusqueda');

        resultados.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-info" role="status"></div></div>';

        try {
            const res = await fetch(`/api/peliculas/buscar?q=${encodeURIComponent(query)}`, {
                credentials: 'same-origin'
            });
            const data = await res.json();

            if (data.exito && data.datos.length > 0) {
                resultados.innerHTML = data.datos.map(pelicula => `
                    <div class="col">
                        <div class="card movie-card h-100 d-flex flex-column">
                            <img src="${pelicula.poster}" class="card-img-top" alt="${pelicula.titulo}"
                                onerror="this.src='https://via.placeholder.com/200x300?text=No+Image'">
                            <div class="card-body d-flex flex-column">
                                <div class="card-content-top">
                                    <h6 class="card-title-container mb-1">
                                        <span class="card-title-text" tabindex="0" data-bs-toggle="popover"
                                            data-bs-trigger="hover focus" data-bs-placement="top"
                                            data-bs-content="${pelicula.titulo}">${pelicula.titulo}</span>
                                    </h6>
                                    <p class="card-text small mb-0">${pelicula.anio}</p>
                                </div>

                                <div class="card-separator my-2"></div>

                                <div class="mt-auto">
                                    <button class="btn btn-card-action w-100 py-2"
                                        onclick="agregarPeliculaAListaActual('${pelicula.imdb_id}', '${pelicula.titulo.replace(/'/g, "\\'")}')">
                                        <i class="bi bi-plus-circle-fill me-1" style="font-size: 1rem;"></i>
                                        Agregar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                setTimeout(() => {
                    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl)
                    })
                }, 100);
            } else {
                resultados.innerHTML = '<div class="col-12 text-center text-muted">No se encontraron resultados</div>';
            }
        } catch (error) {
            console.error(error);
            resultados.innerHTML = '<div class="col-12 text-center text-danger">Error al buscar películas</div>';
        }
    });

    // AGREGAR PELICULA A ESTA LISTA
    async function agregarPeliculaAListaActual(imdbId, titulo) {
        try {
            const res = await fetch('/api/peliculas/agregar-a-lista', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    imdb_id: imdbId,
                    lista_id: listaId
                })
            });
            const data = await res.json();

            if (data.exito) {
                alert(`"${titulo}" agregada a la lista`);
                location.reload();
            } else {
                alert(data.error || 'Error al agregar película');
            }
        } catch (error) {
            console.error(error);
            alert('Error de conexión');
        }
    }

    // BOTON REVIEW
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('.btn-review');
        if (btn) {
            const id = btn.dataset.id;
            const titulo = btn.dataset.titulo;
            const calificacion = btn.dataset.calificacion;
            const comentario = btn.dataset.comentario;
            mostrarModalReview(id, titulo, calificacion, comentario);
        }
    });

    // MOSTRAR MODAL REVIEW
    function mostrarModalReview(peliculaId, titulo, calificacion, comentario) {
        document.getElementById('reviewPeliculaId').value = peliculaId;
        document.getElementById('modalReviewTitle').textContent = `Review: ${titulo}`;
        document.getElementById('calificacion').value = calificacion || '';
        document.getElementById('comentario').value = comentario || '';

        const stars = document.querySelectorAll('#starsRating i');
        stars.forEach((star, index) => {
            if (index < (calificacion || 0)) {
                star.classList.remove('bi-star');
                star.classList.add('bi-star-fill', 'active');
            } else {
                star.classList.remove('bi-star-fill', 'active');
                star.classList.add('bi-star');
            }
        });

        const modal = new bootstrap.Modal(document.getElementById('modalReview'));
        modal.show();
    }

    // SISTEMA DE ESTRELLAS
    document.querySelectorAll('#starsRating i').forEach(star => {
        star.addEventListener('click', function () {
            const rating = parseInt(this.getAttribute('data-rating'));
            document.getElementById('calificacion').value = rating;

            document.querySelectorAll('#starsRating i').forEach((s, index) => {
                if (index < rating) {
                    s.classList.remove('bi-star');
                    s.classList.add('bi-star-fill', 'active');
                } else {
                    s.classList.remove('bi-star-fill', 'active');
                    s.classList.add('bi-star');
                }
            });
        });
    });

    // GUARDAR REVIEW
    async function guardarReview() {
        const peliculaId = document.getElementById('reviewPeliculaId').value;
        const calificacion = document.getElementById('calificacion').value;
        const comentario = document.getElementById('comentario').value;

        if (!calificacion) {
            alert('Por favor selecciona una calificación');
            return;
        }

        try {
            const res = await fetch(`/api/peliculas/${peliculaId}/review`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    calificacion: parseInt(calificacion),
                    comentario: comentario.trim()
                })
            });
            const data = await res.json();

            if (data.exito) {
                location.reload();
            } else {
                alert(data.error || 'Error al guardar review');
            }
        } catch (error) {
            console.error(error);
            alert('Error de conexión');
        }
    }

    // ELIMINAR LISTA
    async function eliminarLista(id) {
        if (!confirm('¿Estás seguro de que quieres eliminar esta lista permanentemente?')) return;

        try {
            const res = await fetch(`/api/listas/${id}`, {
                method: 'DELETE',
                credentials: 'same-origin'
            });
            const data = await res.json();
            if (data.exito) {
                window.location.href = '/dashboard';
            } else {
                alert(data.error || 'Error al eliminar');
            }
        } catch (e) {
            console.error(e);
            alert('Error de conexión');
        }
    }

    // REMOVER PELICULA
    async function removerPelicula(listaId, peliculaId) {
        if (!confirm('¿Quitar película de la lista?')) return;

        try {
            const res = await fetch(`/api/listas/${listaId}/peliculas/${peliculaId}`, {
                method: 'DELETE',
                credentials: 'same-origin'
            });
            const data = await res.json();
            if (data.exito) {
                location.reload();
            } else {
                alert(data.error || 'Error al remover película');
            }
        } catch (e) {
            console.error(e);
            alert('Error de conexión');
        }
    }
</script>