<div class="container py-4">
    <div class="d-flex justify-content-center align-items-center mb-4 position-relative">
        <div class="text-center">
            <h1 class="display-5 fw-bold">{{lista.nombre}}</h1>
            {{#if lista.descripcion}}
            <p class="text-muted lead fw-bold">{{lista.descripcion}}</p>
            {{/if}}
            <span class="badge {{#if lista.es_publica}}bg-success{{else}}bg-secondary{{/if}}">
                {{#if lista.es_publica}}P칰blica{{else}}Privada{{/if}}
            </span>
        </div>
        {{#if esPropietario}}
        <div class="position-absolute end-0">
            <button class="btn btn-danger" onclick="eliminarLista({{lista.id}})">
                <i class="bi bi-trash me-1"></i>Eliminar Lista
            </button>
        </div>
        {{/if}}
    </div>

    {{#if esPropietario}}
    <div class="card search-card mb-4">
        <div class="card-body">
            <h5 class="card-title">
                <i class="bi bi-search me-2"></i>Buscar y Agregar Pel칤culas
            </h5>
            <form id="buscarForm" class="row g-3">
                <div class="col-md-9">
                    <input type="text" id="buscarInput" class="form-control" placeholder="Buscar pel칤culas en OMDb..."
                        required>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-info w-100 h-100">
                        <i class="bi bi-search me-1"></i>Buscar
                    </button>
                </div>
            </form>
            <div id="resultadosBusqueda" class="row row-cols-2 row-cols-md-2 row-cols-lg-4 g-3 mt-2"></div>
        </div>
    </div>
    {{/if}}

    <h3 class="mb-3">Pel칤culas en esta lista</h3>
    {{#if lista.peliculas.length}}
    <div class="row row-cols-2 row-cols-md-2 row-cols-lg-4 g-3">
        {{#each lista.peliculas}}
        <div class="col">
            <div class="card movie-card h-100 d-flex flex-column">
                <img src="{{this.poster}}" class="card-img-top" alt="{{this.titulo}}"
                    onerror="this.src='https://via.placeholder.com/200x300?text=No+Image'">
                <div class="card-body d-flex flex-column">
                    <div class="card-content-top">
                        <h6 class="card-title-container mb-1">
                            <span class="card-title-text" tabindex="0" data-bs-toggle="popover"
                                data-bs-trigger="hover focus" data-bs-placement="top"
                                data-bs-content="{{this.titulo}}">{{this.titulo}}</span>
                        </h6>
                        <span class="badge badge-tipo mb-1">{{this.tipo}}</span>
                        <p class="card-text small mb-0">{{this.anio}}</p>
                    </div>

                    <div class="card-separator my-2"></div>

                    <div class="mt-auto card-content-bottom">
                        {{#if this.mi_calificacion}}
                        <div class="stars-display mb-2">
                            {{#each (range 1 6)}}
                            <i
                                class="bi bi-star{{#if (lte this ../this.mi_calificacion)}}-fill text-warning{{/if}}"></i>
                            {{/each}}
                        </div>
                        {{/if}}

                        {{#if this.mi_comentario}}
                        <div class="review-preview-container mb-2">
                            <span class="comment-preview-text" tabindex="0" data-bs-toggle="popover"
                                data-bs-trigger="hover focus" data-bs-placement="top"
                                data-bs-content="{{this.mi_comentario}}">
                                <i class="bi bi-chat-quote me-1"></i>"{{this.mi_comentario}}"
                            </span>
                        </div>
                        {{/if}}

                        {{#if ../esPropietario}}
                        <div class="d-flex justify-content-center gap-2 card-actions-buttons pt-2">
                            <button class="btn btn-sm btn-card-action btn-comment-action" data-id="{{this.id}}"
                                data-titulo="{{this.titulo}}" data-calificacion="{{this.mi_calificacion}}"
                                data-comentario="{{this.mi_comentario}}" title="Comentario">
                                <i class="bi bi-chat-left-text-fill"></i>
                            </button>
                            <button class="btn btn-sm btn-card-action btn-review" data-id="{{this.id}}"
                                data-titulo="{{this.titulo}}" data-calificacion="{{this.mi_calificacion}}"
                                data-comentario="{{this.mi_comentario}}" title="Calificaci칩n">
                                <i class="bi bi-star-fill"></i>
                            </button>
                            {{#if (or this.mi_calificacion this.mi_comentario)}}
                            <button class="btn btn-sm btn-card-action btn-share-action" data-id="{{this.id}}"
                                data-titulo="{{this.titulo}}" title="Compartir rese침a">
                                <i class="bi bi-share-fill"></i>
                            </button>
                            {{/if}}
                            <button class="btn btn-sm btn-card-action btn-delete-action"
                                onclick="removerPelicula({{../lista.id}}, {{this.id}})" title="Eliminar">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                        {{/if}}
                    </div>
                </div>
            </div>
        </div>
        {{/each}}
    </div>
    {{else}}
    <div class="text-center py-5">
        <i class="bi bi-film display-1 text-muted mb-3"></i>
        <p class="lead text-muted">Esta lista est치 vac칤a. Usa el buscador arriba para agregar pel칤culas.</p>
    </div>
    {{/if}}
</div>

<div class="modal fade" id="modalReview" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="modalReviewTitle">Agregar Review</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formReview">
                    <input type="hidden" id="reviewPeliculaId">
                    <div class="mb-3">
                        <label class="form-label">Calificaci칩n</label>
                        <div class="stars-rating" id="starsRating">
                            <i class="bi bi-star" data-rating="1"></i>
                            <i class="bi bi-star" data-rating="2"></i>
                            <i class="bi bi-star" data-rating="3"></i>
                            <i class="bi bi-star" data-rating="4"></i>
                            <i class="bi bi-star" data-rating="5"></i>
                        </div>
                        <input type="hidden" id="calificacion" name="calificacion">
                    </div>
                    <div class="mb-3">
                        <label for="comentario" class="form-label">Comentario</label>
                        <textarea class="form-control bg-secondary text-light border-dark" id="comentario"
                            name="comentario" rows="3" placeholder="쯇or qu칠 te gusta esta pel칤cula?"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarReview()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Compartir Rese침a -->
<div class="modal fade" id="modalCompartir" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="modalCompartirTitle">
                    <i class="bi bi-share me-2"></i>Compartir Rese침a
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="compartirPeliculaId">
                <input type="hidden" id="compartirPeliculaTitulo">

                <p class="text-center mb-4">Elige c칩mo quieres compartir tu rese침a:</p>

                <div class="d-grid gap-3">
                    <!-- Ver preview -->
                    <a id="btnVerResena" href="#" class="btn btn-share-option btn-preview">
                        <i class="bi bi-eye-fill me-2"></i>Ver Vista Previa
                    </a>

                    <!-- Descargar imagen -->
                    <button type="button" class="btn btn-share-option btn-download-share" onclick="descargarImagenCompartir()">
                        <i class="bi bi-download me-2"></i>Descargar Imagen
                    </button>

                    <!-- Web Share API (solo si est치 disponible) -->
                    <button type="button" class="btn btn-share-option btn-native" id="btnShareNativo" onclick="compartirNativo()" style="display: none;">
                        <i class="bi bi-share me-2"></i>Compartir...
                    </button>

                    <!-- WhatsApp -->
                    <button type="button" class="btn btn-share-option btn-whatsapp-share" onclick="compartirWhatsApp()">
                        <i class="bi bi-whatsapp me-2"></i>WhatsApp
                    </button>

                    <!-- Copiar al portapapeles -->
                    <button type="button" class="btn btn-share-option btn-copy-share" onclick="copiarImagen()">
                        <i class="bi bi-clipboard me-2"></i>Copiar al Portapapeles
                    </button>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<style>
    .stars-rating i {
        font-size: 2rem;
        color: #6c757d;
        cursor: pointer;
        transition: color 0.2s;
    }

    .stars-rating i:hover,
    .stars-rating i.active {
        color: #ffc107;
    }

    .stars-display i {
        font-size: 1rem;
        color: #6c757d;
    }

    .stars-display i.bi-star-fill {
        color: #ffc107;
    }

    .movie-card .card-img-top {
        height: 300px;
        object-fit: cover;
        object-position: center;
    }

    .card-title-container {
        color: var(--ink-black, #081f21);
        font-size: 1.8rem;
        font-weight: 800;
        text-transform: uppercase;
        margin: 0;
        height: 2.6em;
        line-height: 1.3em;
    }

    .card-title-text {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
        word-break: break-word;
    }

    .review-preview-container {
        padding: 6px 8px;
        background: rgba(8, 31, 33, 0.1);
        border-radius: 8px;
        border-left: 3px solid #ffc107;
        height: 3.6em;
        display: flex;
        align-items: flex-start;
    }

    .comment-preview-text {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.85rem;
        font-style: italic;
        color: rgba(8, 31, 33, 0.85);
        cursor: pointer;
        word-break: break-word;
        line-height: 1.4em;
    }

    .comment-preview-text:hover {
        color: #081f21;
    }

    .badge-tipo {
        background-color: var(--pearl-aqua, #69dadc);
        color: var(--ink-black, #081f21);
        font-size: 0.7rem;
        font-weight: 700;
        padding: 0.2rem 0.5rem;
        border-radius: 6px;
        text-transform: uppercase;
        display: inline-block;
    }

    .btn-card-action {
        background-color: var(--ink-black, #081f21) !important;
        color: var(--azure-mist, #eefbfb) !important;
        border: 2px solid var(--ink-black, #081f21) !important;
        border-radius: 10px;
        padding: 0.4rem 0.6rem;
        transition: all 0.2s ease;
    }

    .btn-card-action:hover {
        background-color: var(--royal-gold, #fae04c) !important;
        color: var(--ink-black, #081f21) !important;
        transform: translateY(-2px);
        box-shadow: 3px 3px 0px var(--ink-black, #081f21);
    }

    .btn-card-action i {
        font-size: 1rem;
    }

    .card-separator {
        border-top: 2px dashed rgba(8, 31, 33, 0.2);
        width: 100%;
    }

    .card-content-bottom {
        display: flex;
        flex-direction: column;
    }

    .card-actions-buttons {
        border-top: none;
    }

    .popover {
        background-color: var(--ink-black, #081f21);
        border: 2px solid var(--royal-gold, #fae04c);
        border-radius: 12px;
        box-shadow: 4px 4px 0px var(--pearl-aqua, #69dadc);
    }

    .popover-body {
        color: var(--azure-mist, #eefbfb);
        font-style: italic;
        padding: 0.75rem 1rem;
    }

    .popover-arrow::before,
    .popover-arrow::after {
        border-top-color: var(--ink-black, #081f21) !important;
    }

    /* Estilos para bot칩n de compartir */
    .btn-share-action {
        background-color: var(--pearl-aqua, #69dadc) !important;
        color: var(--ink-black, #081f21) !important;
    }

    .btn-share-action:hover {
        background-color: var(--royal-gold, #fae04c) !important;
    }

    /* Estilos para botones del modal de compartir */
    .btn-share-option {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 14px 20px;
        font-size: 1rem;
        font-weight: 700;
        border-radius: 12px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
    }

    .btn-preview {
        background: var(--pearl-aqua, #69dadc);
        color: var(--ink-black, #081f21);
        border-color: var(--ink-black, #081f21);
    }

    .btn-preview:hover {
        background: #5bc8ca;
        transform: translateY(-2px);
        box-shadow: 3px 3px 0px var(--ink-black, #081f21);
        color: var(--ink-black, #081f21);
    }

    .btn-download-share {
        background: var(--royal-gold, #fae04c);
        color: var(--ink-black, #081f21);
        border-color: var(--ink-black, #081f21);
    }

    .btn-download-share:hover {
        background: #f5d420;
        transform: translateY(-2px);
        box-shadow: 3px 3px 0px var(--ink-black, #081f21);
    }

    .btn-native {
        background: var(--hot-pink-web, #f471b5);
        color: var(--ink-black, #081f21);
        border-color: var(--ink-black, #081f21);
    }

    .btn-native:hover {
        background: #e85aa5;
        transform: translateY(-2px);
        box-shadow: 3px 3px 0px var(--ink-black, #081f21);
    }

    .btn-whatsapp-share {
        background: #25D366;
        color: white;
        border-color: var(--ink-black, #081f21);
    }

    .btn-whatsapp-share:hover {
        background: #20bd5a;
        transform: translateY(-2px);
        box-shadow: 3px 3px 0px var(--ink-black, #081f21);
    }

    .btn-copy-share {
        background: var(--azure-mist, #eefbfb);
        color: var(--ink-black, #081f21);
        border-color: var(--ink-black, #081f21);
    }

    .btn-copy-share:hover {
        background: #dff5f5;
        transform: translateY(-2px);
        box-shadow: 3px 3px 0px var(--ink-black, #081f21);
    }
</style>

<script>
    const listaId = {{ lista.id }};

    // INICIALIZAR POPOVERS
    document.addEventListener('DOMContentLoaded', function () {
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl);
        });
    });

    // BOTON COMENTARIO
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('.btn-comment-action');
        if (btn) {
            const id = btn.dataset.id;
            const titulo = btn.dataset.titulo;
            const calificacion = btn.dataset.calificacion;
            const comentario = btn.dataset.comentario;
            mostrarModalReview(id, titulo, calificacion, comentario);
        }
    });

    // BUSCAR PELICULAS
    document.getElementById('buscarForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = document.getElementById('buscarInput').value;
        const resultados = document.getElementById('resultadosBusqueda');

        resultados.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-info" role="status"></div></div>';

        try {
            const res = await fetch(`/api/peliculas/buscar?q=${encodeURIComponent(query)}`, {
                credentials: 'same-origin'
            });
            const data = await res.json();

            if (data.exito && data.datos.length > 0) {
                resultados.innerHTML = data.datos.map(pelicula => `
                    <div class="col">
                        <div class="card movie-card h-100">
                            <img src="${pelicula.poster}" class="card-img-top" alt="${pelicula.titulo}"
                                onerror="this.src='https://via.placeholder.com/200x300?text=No+Image'">
                            <div class="card-body">
                                <div>
                                    <h6 class="card-title" title="${pelicula.titulo}">${pelicula.titulo}</h6>
                                    <p class="card-text small mb-2">${pelicula.anio}</p>
                                </div>
                                <div class="mt-auto d-flex justify-content-between align-items-center">
                                    <span class="badge bg-secondary text-light border border-light">Resultado</span>
                                    <button class="btn btn-primary btn-add-movie"
                                        data-bs-toggle="tooltip" data-bs-placement="top" title="Agregar a esta lista"
                                        onclick="agregarPeliculaAListaActual('${pelicula.imdb_id}', '${pelicula.titulo.replace(/'/g, "\\'")}')">
                                        <img src="/img/agregar-pelicula.svg" alt="Agregar" class="custom-icon-add">
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                setTimeout(() => {
                    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl)
                    })
                }, 100);
            } else {
                resultados.innerHTML = '<div class="col-12 text-center text-muted">No se encontraron resultados</div>';
            }
        } catch (error) {
            console.error(error);
            resultados.innerHTML = '<div class="col-12 text-center text-danger">Error al buscar pel칤culas</div>';
        }
    });

    // AGREGAR PELICULA A ESTA LISTA
    async function agregarPeliculaAListaActual(imdbId, titulo) {
        try {
            const res = await fetch('/api/peliculas/agregar-a-lista', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    imdb_id: imdbId,
                    lista_id: listaId
                })
            });
            const data = await res.json();

            if (data.exito) {
                alert(`"${titulo}" agregada a la lista`);
                location.reload();
            } else {
                alert(data.error || 'Error al agregar pel칤cula');
            }
        } catch (error) {
            console.error(error);
            alert('Error de conexi칩n');
        }
    }

    // BOTON REVIEW
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('.btn-review');
        if (btn) {
            const id = btn.dataset.id;
            const titulo = btn.dataset.titulo;
            const calificacion = btn.dataset.calificacion;
            const comentario = btn.dataset.comentario;
            mostrarModalReview(id, titulo, calificacion, comentario);
        }
    });

    // MOSTRAR MODAL REVIEW
    function mostrarModalReview(peliculaId, titulo, calificacion, comentario) {
        document.getElementById('reviewPeliculaId').value = peliculaId;
        document.getElementById('modalReviewTitle').textContent = `Review: ${titulo}`;
        document.getElementById('calificacion').value = calificacion || '';
        document.getElementById('comentario').value = comentario || '';

        const stars = document.querySelectorAll('#starsRating i');
        stars.forEach((star, index) => {
            if (index < (calificacion || 0)) {
                star.classList.remove('bi-star');
                star.classList.add('bi-star-fill', 'active');
            } else {
                star.classList.remove('bi-star-fill', 'active');
                star.classList.add('bi-star');
            }
        });

        const modal = new bootstrap.Modal(document.getElementById('modalReview'));
        modal.show();
    }

    // SISTEMA DE ESTRELLAS
    document.querySelectorAll('#starsRating i').forEach(star => {
        star.addEventListener('click', function () {
            const rating = parseInt(this.getAttribute('data-rating'));
            document.getElementById('calificacion').value = rating;

            document.querySelectorAll('#starsRating i').forEach((s, index) => {
                if (index < rating) {
                    s.classList.remove('bi-star');
                    s.classList.add('bi-star-fill', 'active');
                } else {
                    s.classList.remove('bi-star-fill', 'active');
                    s.classList.add('bi-star');
                }
            });
        });
    });

    // GUARDAR REVIEW
    async function guardarReview() {
        const peliculaId = document.getElementById('reviewPeliculaId').value;
        const calificacion = document.getElementById('calificacion').value;
        const comentario = document.getElementById('comentario').value;

        if (!calificacion) {
            alert('Por favor selecciona una calificaci칩n');
            return;
        }

        try {
            const res = await fetch(`/api/peliculas/${peliculaId}/review`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    calificacion: parseInt(calificacion),
                    comentario: comentario.trim()
                })
            });
            const data = await res.json();

            if (data.exito) {
                location.reload();
            } else {
                alert(data.error || 'Error al guardar review');
            }
        } catch (error) {
            console.error(error);
            alert('Error de conexi칩n');
        }
    }

    // ELIMINAR LISTA
    async function eliminarLista(id) {
        if (!confirm('쮼st치s seguro de que quieres eliminar esta lista permanentemente?')) return;

        try {
            const res = await fetch(`/api/listas/${id}`, {
                method: 'DELETE',
                credentials: 'same-origin'
            });
            const data = await res.json();
            if (data.exito) {
                window.location.href = '/dashboard';
            } else {
                alert(data.error || 'Error al eliminar');
            }
        } catch (e) {
            console.error(e);
            alert('Error de conexi칩n');
        }
    }

    // REMOVER PELICULA
    async function removerPelicula(listaId, peliculaId) {
        if (!confirm('쯈uitar pel칤cula de la lista?')) return;

        try {
            const res = await fetch(`/api/listas/${listaId}/peliculas/${peliculaId}`, {
                method: 'DELETE',
                credentials: 'same-origin'
            });
            const data = await res.json();
            if (data.exito) {
                location.reload();
            } else {
                alert(data.error || 'Error al remover pel칤cula');
            }
        } catch (e) {
            console.error(e);
            alert('Error de conexi칩n');
        }
    }

    // ===== FUNCIONES DE COMPARTIR =====

    // Verificar soporte Web Share API al cargar
    document.addEventListener('DOMContentLoaded', function() {
        if (navigator.share) {
            document.getElementById('btnShareNativo').style.display = 'flex';
        }
    });

    // BOTON COMPARTIR - Abrir modal
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('.btn-share-action');
        if (btn) {
            const id = btn.dataset.id;
            const titulo = btn.dataset.titulo;
            mostrarModalCompartir(id, titulo);
        }
    });

    // Mostrar modal de compartir
    function mostrarModalCompartir(peliculaId, titulo) {
        document.getElementById('compartirPeliculaId').value = peliculaId;
        document.getElementById('compartirPeliculaTitulo').value = titulo;
        document.getElementById('modalCompartirTitle').innerHTML = `<i class="bi bi-share me-2"></i>Compartir: ${titulo}`;
        document.getElementById('btnVerResena').href = `/resena/${peliculaId}?lista=${listaId}`;

        const modal = new bootstrap.Modal(document.getElementById('modalCompartir'));
        modal.show();
    }

    // Descargar imagen
    async function descargarImagenCompartir() {
        const peliculaId = document.getElementById('compartirPeliculaId').value;
        const titulo = document.getElementById('compartirPeliculaTitulo').value;
        const btn = document.querySelector('.btn-download-share');
        const originalText = btn.innerHTML;

        btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Generando...';
        btn.disabled = true;

        try {
            const response = await fetch(`/api/peliculas/${peliculaId}/share-image`, {
                credentials: 'same-origin'
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Error al generar imagen');
            }

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `resena-${titulo.replace(/[^a-zA-Z0-9]/g, '-')}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            btn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Descargado!';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        } catch (error) {
            console.error('Error:', error);
            alert(error.message || 'Error al generar la imagen. Intenta de nuevo.');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // Compartir con Web Share API
    async function compartirNativo() {
        const peliculaId = document.getElementById('compartirPeliculaId').value;
        const titulo = document.getElementById('compartirPeliculaTitulo').value;
        const btn = document.getElementById('btnShareNativo');
        const originalText = btn.innerHTML;

        btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Preparando...';
        btn.disabled = true;

        try {
            const response = await fetch(`/api/peliculas/${peliculaId}/share-image`, {
                credentials: 'same-origin'
            });

            if (!response.ok) throw new Error('Error al generar imagen');

            const blob = await response.blob();
            const file = new File([blob], `resena-${titulo}.png`, { type: 'image/png' });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    title: `Mi rese침a de ${titulo}`,
                    text: `Mira mi rese침a de "${titulo}" en Club Palomitas 游`,
                    files: [file]
                });
            } else {
                await navigator.share({
                    title: `Mi rese침a de ${titulo}`,
                    text: `Mira mi rese침a de "${titulo}" en Club Palomitas 游`,
                    url: window.location.href
                });
            }

            btn.innerHTML = originalText;
            btn.disabled = false;
        } catch (error) {
            if (error.name !== 'AbortError') {
                console.error('Error al compartir:', error);
                alert('No se pudo compartir. Intenta descargar la imagen.');
            }
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // Compartir en WhatsApp
    function compartirWhatsApp() {
        const titulo = document.getElementById('compartirPeliculaTitulo').value;
        const texto = encodeURIComponent(`춰Mira mi rese침a de "${titulo}" en Club Palomitas! 游游꿟`);

        if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            window.open(`whatsapp://send?text=${texto}`, '_blank');
        } else {
            window.open(`https://web.whatsapp.com/send?text=${texto}`, '_blank');
        }

        // Tambi칠n descargar la imagen
        descargarImagenCompartir();
    }

    // Copiar imagen al portapapeles
    async function copiarImagen() {
        const peliculaId = document.getElementById('compartirPeliculaId').value;
        const btn = document.querySelector('.btn-copy-share');
        const originalText = btn.innerHTML;

        btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Copiando...';
        btn.disabled = true;

        try {
            const response = await fetch(`/api/peliculas/${peliculaId}/share-image`, {
                credentials: 'same-origin'
            });

            if (!response.ok) throw new Error('Error al generar imagen');

            const blob = await response.blob();

            if (navigator.clipboard && navigator.clipboard.write) {
                const item = new ClipboardItem({ 'image/png': blob });
                await navigator.clipboard.write([item]);
                btn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Copiado!';
            } else {
                throw new Error('Tu navegador no soporta copiar im치genes');
            }

            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        } catch (error) {
            console.error('Error:', error);
            alert('No se pudo copiar la imagen. Intenta descargarla.');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
</script>